<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@mui/material@5.15.8/umd/material-ui.development.js" crossorigin></script>
  <script src="https://unpkg.com/@emotion/react@11.11.1/umd/emotion-react.umd.min.js" crossorigin></script>
  <script src="https://unpkg.com/@emotion/styled@11.11.0/umd/emotion-styled.umd.min.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Box, TextField, Button, Table, TableHead, TableRow, TableCell, TableBody, Select, MenuItem, Checkbox, FormControlLabel } = MaterialUI;

    function AdminApp(){
      const [loggedIn, setLoggedIn] = useState(false);
      const [configs, setConfigs] = useState([]);
      const [tab, setTab] = useState('design');

      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [remember, setRemember] = useState(false);

      const [name, setName] = useState('');
      const [sequence, setSequence] = useState('');
      const [fields, setFields] = useState([]);

      useEffect(() => {
        const saved = localStorage.getItem('adminCreds');
        if(saved){
          const creds = JSON.parse(saved);
          setUsername(creds.username);
          setPassword(creds.password);
          setRemember(true);
        }
      }, []);

      const login = async () => {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if(data.success){
          if(remember){
            localStorage.setItem('adminCreds', JSON.stringify({ username, password }));
          } else {
            localStorage.removeItem('adminCreds');
          }
          setLoggedIn(true);
          loadConfigs();
        } else {
          alert('Invalid credentials');
        }
      };

      const loadConfigs = async () => {
        const res = await fetch('/api/form-configs');
        setConfigs(await res.json());
      };

      const logout = () => {
        setLoggedIn(false);
        setTab('design');
        if(!remember){
          setUsername('');
          setPassword('');
        }
      };

      const addField = () => {
        setFields([...fields, { id:'', label:'', type:'text', options:'' }]);
      };

      const updateField = (idx, key, value) => {
        const copy = fields.slice();
        copy[idx][key] = value;
        setFields(copy);
      };

      const removeField = (idx) => {
        const copy = fields.slice();
        copy.splice(idx,1);
        setFields(copy);
      };

      const saveConfig = async () => {
        const payload = {
          name,
          sequence: Number(sequence),
          fields: fields.map(f=>({
            id: f.id,
            label: f.label,
            type: f.type,
            options: f.options ? f.options.split(',').map(o=>o.trim()).filter(o=>o) : []
          }))
        };
        await fetch('/api/form-configs',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        setName(''); setSequence(''); setFields([]);
        loadConfigs();
      };

      if(!loggedIn){
        return (
          <Box sx={{p:2, maxWidth:400, m:'auto'}}>
            <TextField autoComplete="off" InputLabelProps={{shrink:true}} fullWidth label="Username" margin="normal" value={username} onChange={e=>setUsername(e.target.value)} />
            <TextField autoComplete="off" InputLabelProps={{shrink:true}} fullWidth type="password" label="Password" margin="normal" value={password} onChange={e=>setPassword(e.target.value)} />
            <FormControlLabel control={<Checkbox checked={remember} onChange={e=>setRemember(e.target.checked)} />} label="Remember me" />
            <Button variant="contained" onClick={login}>Login</Button>
          </Box>
        );
      }

      return (
        <Box sx={{display:'flex', height:'100vh'}}>
          <Box sx={{width:250, bgcolor:'#2c3e50', color:'white', p:2, display:'flex', flexDirection:'column', gap:2}}>
            <h2>Admin</h2>
            <Button variant="contained" color="secondary" onClick={()=>setTab('design')}>Design Form</Button>
            <Button variant="contained" color="secondary" onClick={()=>setTab('data')}>View Data</Button>
            <Button variant="outlined" color="inherit" onClick={logout}>Logout</Button>
          </Box>
          <Box sx={{flex:1, p:2, overflow:'auto'}}>
            {tab === 'design' ? (
              <Box>
                <h2>Form Configurations</h2>
                <Box sx={{mb:2}}>
                  <TextField label="Form name" InputLabelProps={{shrink:true}} value={name} onChange={e=>setName(e.target.value)} sx={{mr:2}} />
                  <TextField type="number" label="Sequence" InputLabelProps={{shrink:true}} value={sequence} onChange={e=>setSequence(e.target.value)} />
                </Box>
                {fields.map((f, idx)=>(
                  <FieldEditor key={idx} field={f} isLast={idx===fields.length-1} onChange={(key,val)=>updateField(idx,key,val)} onRemove={()=>removeField(idx)} />
                ))}
                <Box sx={{mt:2}}>
                  <Button variant="contained" color="secondary" onClick={addField} sx={{mr:2}}>Add Field</Button>
                  <Button variant="contained" onClick={saveConfig}>Save Config</Button>
                </Box>
                <Table sx={{mt:4}}>
                  <TableHead>
                    <TableRow><TableCell>Name</TableCell><TableCell>Sequence</TableCell><TableCell>Export</TableCell></TableRow>
                  </TableHead>
                  <TableBody>
                    {configs.map(cfg=>(
                      <TableRow key={cfg.id}>
                        <TableCell>{cfg.name}</TableCell>
                        <TableCell>{cfg.sequence}</TableCell>
                        <TableCell><Button onClick={()=>window.location=`/api/form-configs/${cfg.id}/export`}>Export</Button></TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </Box>
            ) : (
              <RecordsViewer configs={configs} />
            )}
          </Box>
        </Box>
      );
    }

    function FieldEditor({field, onChange, onRemove, isLast}){
      return (
        <Box sx={{display:'flex', gap:1, p:1, border:'1px solid #ccc', borderRadius:1, mb:isLast?0:1}}>
          <TextField label="Id" InputLabelProps={{shrink:true}} value={field.id} onChange={e=>onChange('id', e.target.value)} />
          <TextField label="Label" InputLabelProps={{shrink:true}} value={field.label} onChange={e=>onChange('label', e.target.value)} />
          <Select value={field.type} onChange={e=>onChange('type', e.target.value)}>
            <MenuItem value="text">Text</MenuItem>
            <MenuItem value="textarea">Textarea</MenuItem>
            <MenuItem value="date">Date</MenuItem>
            <MenuItem value="select">Select</MenuItem>
            <MenuItem value="radio">Radio</MenuItem>
          </Select>
          {(field.type === 'select' || field.type === 'radio') && (
            <TextField label="Options (comma separated)" InputLabelProps={{shrink:true}} value={field.options} onChange={e=>onChange('options', e.target.value)} />
          )}
          <Button color="error" onClick={onRemove}>Remove</Button>
        </Box>
      );
    }

    function RecordsViewer({configs}){
      const [configId, setConfigId] = useState('');
      const [records, setRecords] = useState([]);

      useEffect(()=>{
        if(configId){
          fetch(`/api/form-configs/${configId}/records`).then(r=>r.json()).then(setRecords);
        } else {
          setRecords([]);
        }
      }, [configId]);

      return (
        <Box>
          <Select value={configId} onChange={e=>setConfigId(e.target.value)} displayEmpty>
            <MenuItem value=""><em>Select form</em></MenuItem>
            {configs.map(cfg => (
              <MenuItem key={cfg.id} value={cfg.id}>{cfg.name}</MenuItem>
            ))}
          </Select>
          <Box sx={{mt:2}}>
            {records.map((r, idx)=>(
              <Box key={idx} sx={{mb:1, p:1, border:'1px solid #ccc', borderRadius:1}}>
                <pre>{JSON.stringify(r.data, null, 2)}</pre>
              </Box>
            ))}
          </Box>
        </Box>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<AdminApp/>);
  </script>
</body>
</html>
