<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dynamic Forms</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@mui/material@5.15.8/umd/material-ui.development.js" crossorigin></script>
  <script src="https://unpkg.com/@emotion/react@11.11.1/umd/emotion-react.umd.min.js" crossorigin></script>
  <script src="https://unpkg.com/@emotion/styled@11.11.0/umd/emotion-styled.umd.min.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Tabs, Tab, Box, TextField, Button, MenuItem, RadioGroup, FormControlLabel, Radio, FormLabel, Select, InputLabel, Table, TableHead, TableRow, TableCell, TableBody, Snackbar } = MaterialUI;

    function App(){
      const [configs, setConfigs] = useState([]);
      const [current, setCurrent] = useState(0);
      const [formValues, setFormValues] = useState({});
      const [records, setRecords] = useState([]);
      const [toast, setToast] = useState(false);

      const loadConfigs = async () => {
        const data = await fetch('/api/form-configs').then(r=>r.json());
        setConfigs(data);
        const initial = {};
        data.forEach(cfg=>{ initial[cfg._id] = {}; });
        setFormValues(initial);
      };

      const loadRecords = async () => {
        const recs = await fetch('/api/form-records').then(r=>r.json());
        setRecords(recs);
      };

      useEffect(() => {
        loadConfigs();
        loadRecords();
      }, []);

      const updateValue = (formId, fieldId, value) => {
        setFormValues(prev => ({ ...prev, [formId]: { ...(prev[formId]||{}), [fieldId]: value } }));
      };

      const handleSubmit = async (cfg) => {
        await fetch(`/api/form-configs/${cfg._id}/records`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formValues[cfg._id] || {})
        });
        setFormValues(prev => ({ ...prev, [cfg._id]: {} }));
        await loadRecords();
        setToast(true);
      };

      const handleRecordSelect = (rec) => {
        const index = configs.findIndex(c=>c._id===rec.formId);
        if(index>=0){
          setCurrent(index);
          setFormValues(prev=>({ ...prev, [rec.formId]: rec.data }));
          window.scrollTo({top:0, behavior:'smooth'});
        }
      };

      return (
        <Box sx={{p:2}}>
          <Tabs value={current} onChange={(e,v)=>setCurrent(v)}>
            {configs.map((cfg, idx)=>(
              <Tab label={cfg.formCd} key={cfg._id} />
            ))}
          </Tabs>
          {configs[current] && (
            <FormRenderer config={configs[current]} values={formValues[configs[current]._id] || {}} onChangeField={(id,val)=>updateValue(configs[current]._id,id,val)} onSubmit={()=>handleSubmit(configs[current])} />
          )}
          <RecordList records={records} configs={configs} onSelect={handleRecordSelect} />
          <Snackbar open={toast} autoHideDuration={2000} message="Saved" onClose={()=>setToast(false)} />
        </Box>
      );
    }

    function FormRenderer({config, values, onChangeField, onSubmit}){
      const fields = config.fields || [];

      const submit = (e) => {
        e.preventDefault();
        onSubmit();
      };

      return (
        <Box component="form" onSubmit={submit} sx={{mt:2, p:2, border:'1px solid #ccc', borderRadius:1, maxWidth:500, mx:'auto'}}>
          {fields.map(f=>(
            <Box key={f.fieldId} sx={{mb:2}}>
              {renderField(f, values[f.fieldId] || '', (val)=>onChangeField(f.fieldId, val))}
            </Box>
          ))}
          <Button type="submit" variant="contained">Submit</Button>
        </Box>
      );
    }

    function renderField(f, value, onChange){
      switch(f.type){
        case 'textarea':
          return <TextField fullWidth multiline label={f.label} value={value} onChange={e=>onChange(e.target.value)} />;
        case 'date':
          return <TextField fullWidth type="date" label={f.label} InputLabelProps={{ shrink:true }} value={value} onChange={e=>onChange(e.target.value)} />;
        case 'select':
          return (
            <TextField select fullWidth label={f.label} value={value} onChange={e=>onChange(e.target.value)}>
              {(f.option||[]).map(o=>(
                <MenuItem key={o} value={o}>{o}</MenuItem>
              ))}
            </TextField>
          );
        case 'radio':
          return (
            <Box>
              <FormLabel>{f.label}</FormLabel>
              <RadioGroup value={value} onChange={e=>onChange(e.target.value)}>
                {(f.option||[]).map(o=>(
                  <FormControlLabel key={o} value={o} control={<Radio />} label={o} />
                ))}
              </RadioGroup>
            </Box>
          );
        default:
          return <TextField fullWidth label={f.label} value={value} onChange={e=>onChange(e.target.value)} />;
      }
    }

    function RecordList({records, configs, onSelect}){
      return (
        <Box sx={{mt:4}}>
          <h3>Records</h3>
          <Table>
            <TableHead>
              <TableRow><TableCell>Form</TableCell><TableCell>Action</TableCell></TableRow>
            </TableHead>
            <TableBody>
              {records.map(rec=>{
                const cfg = configs.find(c=>c._id===rec.formId);
                return (
                  <TableRow key={rec.id}>
                    <TableCell>{cfg ? cfg.formCd : rec.formId}</TableCell>
                    <TableCell><Button onClick={()=>onSelect(rec)}>Select</Button></TableCell>
                  </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </Box>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
